<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>4QS Results Summary</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    .summary {
      max-width: 750px;
      margin: 40px auto;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    canvas {
      max-width: 100%;
      margin-top: 30px;
      height: auto;
    }
    h1 {
      margin-bottom: 20px;
      color: #0056b3;
    }
    h2 {
      margin-top: 25px;
      margin-bottom: 10px;
      color: #5a5a5a;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
      text-align: left;
    }
    .scores p, .user-info p {
      font-size: 1.1em;
      margin: 8px 0;
      text-align: left;
    }
    .user-info {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .scores {
      margin-top: 20px;
    }
    .scores strong {
      display: inline-block;
      min-width: 180px;
      color: #333;
    }
    .final-score {
      font-size: 1.3em;
      font-weight: bold;
      color: #0056b3;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      text-align: center;
    }
    #sync-status {
      margin-top: 25px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      text-align: center;
    }
    .sync-success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .sync-error {
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="summary" id="resultContent">
    <h1>üéØ Your 4QS Report</h1>
    <div class="user-info" id="userDetails"></div>
    <div class="scores" id="scoreOutput"></div>
    <canvas id="radarChart"></canvas>
    <div id="sync-status"></div>
  </div>

  <script>
    const TESTS = ["iq", "eq", "aq", "sq", "stress"];
    const GOOGLE_SCRIPT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjjy6uiAMcUKHKMWE5LRIW1Ry_29hqYuHcKCs0dWxjB7c08jes1jVH_vLixo8YEG-K304goRvb3jpG60rnkmi9plteA22q_Xe4K2aOB7EUj8xstnUHNqjIjmAJYvmNHCqhIAmL6pjRt9Wj_COcmxZbW9-z5pqePRTbx5V8pS4bqTqah9UwE8lRWa16BNizMkZjByHH_nhUD3g6MGvI8ie9btUdFygaJ45JBfgyhumvWc7LhQI00LSmi10LpiQ&lib=MC-w43-cGRgZ9g3cyVlOBSPoH_GRKR_iH";
    const userDetailsDiv = document.getElementById("userDetails");
    const scoreOutputDiv = document.getElementById("scoreOutput");
    const syncStatusDiv = document.getElementById("sync-status");
    const chartCanvas = document.getElementById("radarChart");

    function getStoredJson(key, defaultValue = null) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch {
        return defaultValue;
      }
    }

    function displayUserInfo(user) {
      userDetailsDiv.innerHTML = `
        <h2>üë§ Participant Info</h2>
        <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
        <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
        <p><strong>Age:</strong> ${user.age || 'N/A'}</p>
        <p><strong>Gender:</strong> ${user.gender || 'N/A'}</p>
        <p><strong>Profession:</strong> ${user.profession || 'N/A'}</p>`;
    }

    function scoreIQ(responses, shownQuestions) {
      if (!responses || !shownQuestions || shownQuestions.length === 0) return { score: 0, attempted: 0, correct: 0 };
      let correct = 0, attempted = 0;
      responses.forEach((r, i) => {
        if (r && i < shownQuestions.length) {
          attempted++;
          if (r.trim().toLowerCase() === shownQuestions[i]?.answer?.trim().toLowerCase()) correct++;
        }
      });
      return { score: Math.round((correct / shownQuestions.length) * 100), attempted, correct };
    }

    async function scoreComposite(testName, labelPrefix = "") {
      const responses = getStoredJson(`${testName}_responses`, []);
      let questions = [];
      try {
        const res = await fetch(`questions/${testName}.json`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        questions = await res.json();
      } catch {
        scoreOutputDiv.innerHTML += `<p class="sync-error">‚ö†Ô∏è Failed to load ${testName}.json</p>`;
        return { score: 0, attempted: 0 };
      }

      const scale = { "Strongly Disagree": 1, "Disagree": 2, "Neutral": 3, "Agree": 4, "Strongly Agree": 5, "Never": 1, "Rarely": 2, "Sometimes": 3, "Often": 4, "Very Often": 5 };
      const compScores = {}, composites = {};
      let attempted = 0;

      responses.forEach((response, i) => {
        const q = questions[i];
        const val = scale[response] || 0;
        if (val && q) {
          attempted++;
          const score = q.reverse ? 6 - val : val;
          const comp = q.composite || "General";
          if (!compScores[comp]) compScores[comp] = { total: 0, count: 0 };
          compScores[comp].total += score;
          compScores[comp].count++;
        }
      });

      let sum = 0, count = 0;
      for (const c in compScores) {
        const percent = Math.round((compScores[c].total / (compScores[c].count * 5)) * 100);
        composites[c] = percent;
        scoreOutputDiv.innerHTML += `<p><strong>${labelPrefix}${c}:</strong> ${percent} / 100</p>`;
        sum += percent;
        count++;
      }

      return { score: count ? Math.round(sum / count) : 0, attempted, composites };
    }

    function displayChart(scores) {
      const chart = Chart.getChart(chartCanvas);
      if (chart) chart.destroy();
      new Chart(chartCanvas, {
        type: "radar",
        data: {
          labels: ["IQ", "EQ", "AQ", "SQ", "Stress"],
          datasets: [{
            label: "Your Score",
            data: [
              scores.IQ?.score ?? 0,
              scores.EQ?.score ?? 0,
              scores.AQ?.score ?? 0,
              scores.SQ?.score ?? 0,
              scores.STRESS?.score ?? 0,
            ],
            fill: true,
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.2)",
            pointBackgroundColor: "#007bff"
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: { suggestedMin: 0, suggestedMax: 100 }
          }
        }
      });
    }

    async function submitResults(payload) {
      syncStatusDiv.innerText = "‚è≥ Submitting results...";
      syncStatusDiv.className = '';
      try {
        const res = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === "success") {
          syncStatusDiv.innerText = "‚úÖ Submission successful!";
          syncStatusDiv.className = "sync-success";
          TESTS.forEach(t => localStorage.removeItem(`${t}_responses`));
          localStorage.removeItem("iq_questions_shown");
          localStorage.removeItem("user_info");
        } else {
          throw new Error(data.message);
        }
      } catch (e) {
        syncStatusDiv.innerText = `‚ùå Submission failed: ${e.message}`;
        syncStatusDiv.className = "sync-error";
      }
    }

    async function calculateAndDisplayResults() {
      const user = getStoredJson("user_info", {});
      displayUserInfo(user);
      scoreOutputDiv.innerHTML = "<h2>üìä Score Breakdown</h2>";
      const scores = {};

      for (const test of TESTS) {
        const key = test.toUpperCase();
        const responses = getStoredJson(`${test}_responses`, []);
        if (test === "iq") {
          const shown = getStoredJson("iq_questions_shown", []);
          scores.IQ = scoreIQ(responses, shown);
          scoreOutputDiv.innerHTML += `<p><strong>IQ Score:</strong> ${scores.IQ.score} / 100</p><p><small>(Attempted: ${scores.IQ.attempted}, Correct: ${scores.IQ.correct})</small></p><hr/>`;
        } else {
          const result = await scoreComposite(test, `${key} - `);
          scores[key] = result;
          scoreOutputDiv.innerHTML += `<p><strong>${key} Overall:</strong> ${result.score} / 100</p><p><small>(Attempted: ${result.attempted})</small></p><hr/>`;
        }
      }

      const final4qs = Math.round((scores.IQ.score + scores.EQ.score + scores.AQ.score + scores.SQ.score) / 4);
      scoreOutputDiv.innerHTML += `<p class="final-score">üß† Final 4QS Score: ${final4qs} / 100</p>`;

      displayChart(scores);

      await submitResults({
        timestamp: new Date().toISOString(),
        name: user.name || "",
        email: user.email || "",
        age: user.age || "",
        gender: user.gender || "",
        profession: user.profession || "",
        iq: scores.IQ.score,
        eq: scores.EQ.score,
        aq: scores.AQ.score,
        sq: scores.SQ.score,
        stress: scores.STRESS.score,
        fourqs: final4qs
      });
    }

    calculateAndDisplayResults();
  </script>
</body>
</html>
