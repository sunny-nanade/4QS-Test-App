<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>4QS Test Interface</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    #question-container { margin-top: 20px; }
    .question-box { margin-bottom: 30px; }
    .options label, .scale label { display: block; margin: 5px 0; }
    #timer { font-weight: bold; color: darkred; margin-bottom: 10px; }
    #test-title { font-size: 1.2rem; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª 4QS Test</h1>
    <div id="test-title"></div>
    <div id="timer"></div>
    <div id="question-container"></div>
    <button id="prevBtn" style="display:none;">Previous</button>
    <button id="nextBtn" style="display:none;">Next</button>
    <button id="submitBtn" style="display:none;">Submit</button>
  </div>

  <footer id="test-source" style="margin-top: 40px; text-align:center; font-size: 14px;"></footer>

  <script>
    const container = document.getElementById("question-container");
    const footer = document.getElementById("test-source");
    const timerDisplay = document.getElementById("timer");
    const testTitle = document.getElementById("test-title");

    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    const submitBtn = document.getElementById("submitBtn");

    let questions = [], currentIndex = 0, responses = [], testName = "", maxQuestions = 20;
    let timer, timeLeft = 0;

    const sources = {
      iq: "Based on the Wonderlic Cognitive Ability Test",
      eq: "Based on the EQ-i 2.0 Model (Bar-On)",
      aq: "Based on the CORE Model by Dr. Paul Stoltz",
      sq: "Based on the SISRI-24 Inventory (King, 2008)",
      stress: "Based on the Perceived Stress Scale (PSS-10) by Cohen et al."
    };

    const durations = {
      iq: 14 * 60,
      eq: 9 * 60,
      aq: 9 * 60,
      sq: 10 * 60,
      stress: 4 * 60
    };

    window.onload = () => {
      const urlParams = new URLSearchParams(window.location.search);
      testName = urlParams.get('test');
      if (!testName || !sources[testName]) {
        container.innerHTML = "<p style='color:red;'>Test not specified. Append ?test=iq or ?test=eq etc. in URL.</p>";
        return;
      }
      testTitle.innerText = `${testName.toUpperCase()} Test`;
      footer.textContent = sources[testName];
      timeLeft = durations[testName];

      fetch(`questions/${testName}.json`).then(res => res.json()).then(all => {
        maxQuestions = testName === "stress" ? 10 : 20;
        questions = all.sort(() => 0.5 - Math.random()).slice(0, maxQuestions);
        responses = new Array(questions.length).fill(null);
        currentIndex = 0;
        startTimer();
        showQuestion();
        nextBtn.style.display = "inline-block";
        prevBtn.style.display = "inline-block";
      });
    };

    function startTimer() {
      updateTimerDisplay();
      timer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timer);
          submitTest();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      timerDisplay.textContent = `Time Left: ${min}:${sec.toString().padStart(2, '0')}`;
    }

    function showQuestion() {
      const q = questions[currentIndex];
      container.innerHTML = `
        <div class="question-box">
          <h3>Question ${currentIndex + 1} of ${questions.length}</h3>
          <p>${q.question}</p>
          <div class="options">${generateOptions(q, currentIndex)}</div>
        </div>
      `;
      submitBtn.style.display = responses.every(r => r !== null) ? "inline-block" : "none";
      prevBtn.style.display = currentIndex > 0 ? "inline-block" : "none";
      nextBtn.style.display = currentIndex < questions.length - 1 ? "inline-block" : "none";
    }

    function generateOptions(q, idx) {
      const options = q.options || q.scale;
      return options.map(opt => `
        <label><input type="radio" name="q${idx}" value="${opt}" ${responses[idx] === opt ? "checked" : ""}/> ${opt}</label>
      `).join("");
    }

    container.addEventListener("change", e => {
      if (e.target.name.startsWith("q")) {
        const idx = parseInt(e.target.name.substring(1));
        responses[idx] = e.target.value;
        submitBtn.style.display = responses.every(r => r !== null) ? "inline-block" : "none";
      }
    });

    nextBtn.onclick = () => {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        showQuestion();
      }
    };

    prevBtn.onclick = () => {
      if (currentIndex > 0) {
        currentIndex--;
        showQuestion();
      }
    };

    submitBtn.onclick = () => {
      submitTest();
    };

    function submitTest() {
      clearInterval(timer);
      if (responses.includes(null)) {
        alert("Please answer all questions.");
        return;
      }

      localStorage.setItem(`${testName}_responses`, JSON.stringify(responses));

      const testOrder = ["iq", "eq", "aq", "sq", "stress"];
      const currentIndexInOrder = testOrder.indexOf(testName);
      const nextTest = testOrder[currentIndexInOrder + 1];

      if (nextTest) {
        window.location.href = `test.html?test=${nextTest}`;
      } else {
        // Only show results page after completing all tests
        window.location.href = "results.html";
      }
    }
  </script>
</body>
</html>
